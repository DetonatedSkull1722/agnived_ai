<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Uploader</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #007bff;
        }

        .user-info {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .role-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .role-admin {
            background-color: #dc3545;
            color: white;
        }

        .role-user {
            background-color: #28a745;
            color: white;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #545b62;
        }

        .form-group {
            margin-bottom: 15px;
        }

        input[type="file"] {
            padding: 10px;
            border: 2px dashed #007bff;
            border-radius: 5px;
            width: 100%;
            cursor: pointer;
        }

        .flash-messages {
            margin-bottom: 20px;
        }

        .flash {
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .flash-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        #output {
            margin-top: 15px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
        }

        /* History Section Styles */
        .history-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #007bff;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .history-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .history-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .history-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .history-item-info {
            padding: 15px;
        }

        .history-item-filename {
            font-weight: bold;
            margin-bottom: 8px;
            word-break: break-all;
            color: #333;
        }

        .history-item-meta {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .history-item-location {
            font-size: 11px;
            color: #007bff;
            background: #e7f3ff;
            padding: 5px 8px;
            border-radius: 4px;
            margin-top: 8px;
        }

        .no-history {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #007bff;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Image Uploader</h1>
            <div class="user-info">
                <span>Welcome, <strong>{{ session.username }}</strong></span>
                <span class="role-badge role-{{ session.role }}">{{ session.role }}</span>
                <a href="/analysis" class="btn btn-primary">üìç Map Analysis</a>
                {% if session.role == 'admin' %}
                <a href="/admin/dashboard" class="btn btn-danger">Admin Dashboard</a>
                {% endif %}
                <a href="/logout" class="btn btn-secondary">Logout</a>
            </div>
        </div>

        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="flash-messages">
            {% for message in messages %}
            <div class="flash flash-success">{{ message }}</div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <form action="/upload" method="POST" enctype="multipart/form-data">
            <div class="form-group">
                <label for="image">Select Image:</label>
                <input type="file" name="image" id="image" accept="image/*" required>
            </div>

            <div class="form-group">
                <label>Location Information:</label>
                <div style="margin-top: 10px;">
                    <label style="margin-right: 15px;">
                        <input type="radio" name="locationMethod" value="auto" checked onclick="toggleLocationMethod()">
                        Auto-detect location
                    </label>
                    <label>
                        <input type="radio" name="locationMethod" value="manual" onclick="toggleLocationMethod()">
                        Enter manually
                    </label>
                </div>
            </div>

            <!-- Auto-detect section -->
            <div id="autoLocationSection" style="margin-bottom: 15px;">
                <button type="button" class="btn btn-secondary" onclick="getLocation()">Get My Location</button>
                <p id="output" style="margin-top: 10px; font-weight: bold; color: #007bff;"></p>
            </div>

            <!-- Manual entry section -->
            <div id="manualLocationSection" style="display: none; margin-bottom: 15px;">
                <div class="form-group">
                    <label for="manualLat">Latitude:</label>
                    <input type="number" id="manualLat" step="any" placeholder="e.g., 40.7128" 
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                           onchange="updateManualLocation()">
                </div>
                <div class="form-group">
                    <label for="manualLon">Longitude:</label>
                    <input type="number" id="manualLon" step="any" placeholder="e.g., -74.0060"
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                           onchange="updateManualLocation()">
                </div>
            </div>

            <!-- Hidden fields to send lat & lon -->
            <input type="hidden" name="latitude" id="latitude">
            <input type="hidden" name="longitude" id="longitude">

            <button type="submit" class="btn btn-primary">Upload Image</button>
        </form>

        <!-- Upload History Section -->
        <div class="history-section">
            <div class="history-header">
                <h2>Upload History</h2>
                <button class="btn btn-secondary" onclick="loadUploadHistory()">Refresh</button>
            </div>
            <div id="historyContainer">
                <div class="loading">Loading your uploads...</div>
            </div>
        </div>
    </div>

    <script>
        function toggleLocationMethod() {
            const autoSection = document.getElementById('autoLocationSection');
            const manualSection = document.getElementById('manualLocationSection');
            const selectedMethod = document.querySelector('input[name="locationMethod"]:checked').value;

            if (selectedMethod === 'auto') {
                autoSection.style.display = 'block';
                manualSection.style.display = 'none';
                // Clear manual inputs
                document.getElementById('manualLat').value = '';
                document.getElementById('manualLon').value = '';
                // Clear hidden fields
                document.getElementById('latitude').value = '';
                document.getElementById('longitude').value = '';
                document.getElementById('output').textContent = '';
            } else {
                autoSection.style.display = 'none';
                manualSection.style.display = 'block';
                // Clear auto-detected location
                document.getElementById('latitude').value = '';
                document.getElementById('longitude').value = '';
                document.getElementById('output').textContent = '';
            }
        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;

                        // Show on page
                        document.getElementById("output").textContent =
                            `Location detected: Latitude: ${lat.toFixed(6)}, Longitude: ${lon.toFixed(6)}`;

                        // Put into hidden inputs so they go with the form
                        document.getElementById("latitude").value = lat;
                        document.getElementById("longitude").value = lon;
                    },
                    (error) => {
                        console.error(error);
                        document.getElementById("output").textContent = "Unable to fetch location!";
                        document.getElementById("output").style.color = "#dc3545";
                    }
                );
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        function updateManualLocation() {
            const lat = document.getElementById('manualLat').value;
            const lon = document.getElementById('manualLon').value;

            if (lat && lon) {
                document.getElementById('latitude').value = lat;
                document.getElementById('longitude').value = lon;
            }
        }

        // Form validation to ensure location is provided
        document.querySelector('form').addEventListener('submit', function(e) {
            const lat = document.getElementById('latitude').value;
            const lon = document.getElementById('longitude').value;
            const selectedMethod = document.querySelector('input[name="locationMethod"]:checked').value;

            if (!lat || !lon) {
                e.preventDefault();
                if (selectedMethod === 'auto') {
                    alert('Please click "Get My Location" button to fetch your location before uploading.');
                } else {
                    alert('Please enter both latitude and longitude values before uploading.');
                }
            }
        });

        // Load upload history on page load
        window.addEventListener('DOMContentLoaded', function() {
            loadUploadHistory();
        });

        // Function to load upload history
        function loadUploadHistory() {
            const historyContainer = document.getElementById('historyContainer');
            historyContainer.innerHTML = '<div class="loading">Loading your uploads...</div>';

            fetch('/user/uploads')
                .then(response => response.json())
                .then(data => {
                    if (data.uploads && data.uploads.length > 0) {
                        displayUploads(data.uploads);
                    } else {
                        historyContainer.innerHTML = '<div class="no-history">No uploads yet. Upload your first image above!</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading history:', error);
                    historyContainer.innerHTML = '<div class="no-history">Failed to load upload history. Please try again.</div>';
                });
        }

        // Function to display uploads
        function displayUploads(uploads) {
            const historyContainer = document.getElementById('historyContainer');
            const grid = document.createElement('div');
            grid.className = 'history-grid';

            uploads.forEach(upload => {
                const item = document.createElement('div');
                item.className = 'history-item';

                const img = document.createElement('img');
                img.src = `/image/${upload.id}`;
                img.alt = upload.filename;
                img.loading = 'lazy';

                const info = document.createElement('div');
                info.className = 'history-item-info';

                const filename = document.createElement('div');
                filename.className = 'history-item-filename';
                filename.textContent = upload.filename;

                const date = document.createElement('div');
                date.className = 'history-item-meta';
                const uploadDate = new Date(upload.created_at);
                date.textContent = `Uploaded: ${uploadDate.toLocaleString()}`;

                info.appendChild(filename);
                info.appendChild(date);

                // Add location info if available
                if (upload.latitude && upload.longitude) {
                    const location = document.createElement('div');
                    location.className = 'history-item-location';
                    location.textContent = `üìç Lat: ${upload.latitude.toFixed(6)}, Lon: ${upload.longitude.toFixed(6)}`;
                    info.appendChild(location);
                }

                item.appendChild(img);
                item.appendChild(info);
                grid.appendChild(item);
            });

            historyContainer.innerHTML = '';
            historyContainer.appendChild(grid);
        }

        // Reload history after successful upload
        document.querySelector('form').addEventListener('submit', function(e) {
            const originalAction = this.action;
            const formData = new FormData(this);

            // Check if location is provided
            const lat = document.getElementById('latitude').value;
            const lon = document.getElementById('longitude').value;
            const selectedMethod = document.querySelector('input[name="locationMethod"]:checked').value;

            if (!lat || !lon) {
                e.preventDefault();
                if (selectedMethod === 'auto') {
                    alert('Please click "Get My Location" button to fetch your location before uploading.');
                } else {
                    alert('Please enter both latitude and longitude values before uploading.');
                }
                return;
            }

            // Submit via AJAX to reload history automatically
            e.preventDefault();
            
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert('Upload successful!');
                    // Reset form
                    document.getElementById('image').value = '';
                    document.getElementById('latitude').value = '';
                    document.getElementById('longitude').value = '';
                    document.getElementById('output').textContent = '';
                    // Reload history
                    loadUploadHistory();
                } else if (data.error) {
                    alert('Upload failed: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                alert('Upload failed. Please try again.');
            });
        });
    </script>
</body>

</html>